---
title: "IS publication exploration"
author: "Maya Lapp"
date: "1/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Documents/WoosterStuff/fall2019/IS_organized/analysis")
library(tidyverse)
library(ggthemes)
library(gridExtra)
library(patchwork)
library(ggforce)
#library(pheatmap)
library(ggpubr)
library(colorspace)


```

```{r, warning=FALSE}
source(file="setupFile2.R")
source(file="setupVallino.R") # only working second time it is run???? 
```

default graph settings 
```{r}
color="Set2"
axlab_size <- 12
axtick_size <- 10
  
ax_kf = expression(paste(bolditalic("final-institution "),bold("("), K[f], bold(")")))
axlab_bm<-"Biomass (% remaining)"
axlab_density <- "Density"
axlab_time <- "Period"
axlab_perc <- "Percent remianing"
ax_sanc = expression(bolditalic(sanction-level))
ax_mon = expression(bolditalic(monitoring-level))
ax_rt=expression(bolditalic("reference-threshold"))
ax_surveillance=expression(bold(bolditalic("surveillance-level")))
ax_mc=expression(bold(bolditalic("minimum-cut")))
ax_k=expression(paste(bold(bolditalic("current-institution ")), bold("(K)")))



# make graph look nice by adding this to the end 
setGraphs<- theme_bw()+
  theme(axis.text=element_text(size=axtick_size, color="black"),
        axis.title=element_text(size=axlab_size,face="bold", color="black"), legend.text = element_text(size=axtick_size))+
  theme(panel.border = element_blank(), axis.line = element_line(colour = "black"))

#  scale_color_stata()
# scale_color_brewer(palette="Set1")
#colorDiscrete = scale_color_brewer(palette="Dark2")
colorDiscrete = scale_color_brewer(palette="Set2")
colorCont = scale_color_viridis_c(option = "magma")
#fillDiscrete = scale_fill_brewer(palette="Dark2")
fillDiscrete = scale_fill_brewer(palette="Set2")
fillCont = scale_fill_viridis_c(option = "magma")

# first two colors in Dark2
#1b9e77
#d95f02

color1="#66c2a5"
color2="#fc8d62"
color3="#8da0cb"

# scale_color_colorblind()
# scale_color_OkabeIto()

point_size = 3
line_size = 1.2
```



## Publication stuff/experimenting 

check low illegal BM when monitoring = 0 
```{r}
data_mon0$PercIllegalBM[200]
data_mon0
```


examine rt of loggers removed, (C&E model base parameters), to show loggers removed are MORE environmental than average logger 
```{r}
# removedRTData_vallino_stats = removedRTData_vallino%>%mutate(rtDifference)
rt_removed_testing = data.frame(rt_initial = rep(0, times = 50), rt_removed = rep(0, times = 50))
for (i in 1:50) {
  rt_removed_testing$rt_initial[i] = vallino_data_removed_rt[[1]][[i]][["beta.i"]][[1]]
  rt_removed_testing$rt_removed[i] = vallino_data_removed_rt[[1]][[i]][["avgRTremoved"]][[200]]
}

rt_removed_testing = rt_removed_testing%>%mutate(rt_difference = rt_removed - rt_initial)

rt_removed_testing%>%ggplot(aes(x = rt_difference))+
  geom_histogram()

mean(rt_removed_testing$rt_difference)

```




calculating jumps - for rt graph iwth lines of best fit 
```{r}
x<-maxK(dataRT, seq(1,10, by=1), 2000, 50)

#jumps_test<-findKJumps(dataRT, seq(1,10, by=1), 2000, 50)
numberJumps<-findKJumps(dataRT, seq(1,10, by=1), 2000, 50)
whenFinalJump<-findFinalKJumps(dataRT, seq(1,10, by=1), 2000, 50)

numberJumps2<-numberJumps%>%gather(key="variableValue", value=variableOfInterest)%>%separate(col = variableValue, into = c("type", "variableValue"))

jumpDF<-data.frame(maxK=x, jumps=numberJumps2$variableOfInterest, K=rtData$K, TotalBM=rtData$TotalBM, variableValue=rtData$variableValue, cheaters=rtData$numCheaters)

whenFinalJump2<-whenFinalJump%>%gather(key="variableValue", value=variableOfInterest)%>%separate(col = variableValue, into = c("type", "variableValue"))
rtJumpData<-data.frame(maxK=x, numJumps = numberJumps2$variableOfInterest, finalJump=whenFinalJump2$variableOfInterest, K=rtData$K, TotalBM=rtData$TotalBM, variableValue=rtData$variableValue, cheaters=rtData$numCheaters)

rtJumpData<- rtJumpData%>%mutate(recentMeeting = finalJump>20)
rtJumpData<- rtJumpData%>%mutate(jumpCat = ifelse(as.numeric(numJumps)<2,"once", ifelse(as.numeric(numJumps)<3, "twice","3+ times")))%>%mutate(jumpCat=factor(jumpCat))

```

rt jumps scatterplot - add lines of best fit 
```{r}
x = lm(rtJumpData$K~ as.numeric(rtJumpData$variableValue))
summary(x)
  viz_rt_jump=rtJumpData%>%ggplot(aes(x = as.numeric(variableValue)/10, y = K, color=jumpCat))+
  geom_point(aes(shape=recentMeeting, size=recentMeeting), position="jitter")+
  geom_smooth(method='lm', se = FALSE, show.legend = FALSE)+ 
  scale_color_brewer(palette="Set2",breaks=c("once", "twice", "3+ times"),name="Number of meetings", labels = c("1", "2", "3+"))+
  scale_shape(name="", breaks=c(TRUE, FALSE), labels=c("Recent meeting", "No recent meeting"))+
  scale_size_manual(breaks=c(TRUE, FALSE), values=c(2.5,1.5))+
  labs(x=ax_rt, y=ax_kf)+
  setGraphs+ 
  guides(color = guide_legend(override.aes = list(size = 3)), shape = guide_legend(override.aes = list(size = 3)), size=FALSE)
viz_rt_jump

ggsave("./figs/viz_rtJump.pdf", viz_rt_jump, width=5.75, height=3, units="in")


```
colored surveilance (not using)
```{r}
enfGraph=enfData_vallino%>%mutate(enfValue=rev(as.factor((as.numeric(variableValue)-1)/10)))
enfGraph%>%ggplot(aes(x=(enfValue), y=TotalBM*100))+geom_point(aes(color = numLoggers), alpha = 0.7, size = 4)+
  labs(y=axlab_bm, x=ax_surveillance)+
  scale_color_gradient( limits=c(0.45, 0.7))+
  setGraphs
```
monitoring and sanctioning do matter, after considering K 
```{r}
viz_mon_2_8 = monitoringData%>% filter(variableValue == 20| variableValue == 80)%>%ggplot(aes(x= K, y = TotalBM*100))+
  geom_point(aes(color = variableValue))+
  labs(color = ax_mon)+
  ylab(axlab_bm)+
  xlab(ax_kf)+
  setGraphs+
  colorDiscrete+
  #ylim(0,23)+
  #xlim(7.5,15)+
  theme(legend.position="bottom")


#viz_sanc_2_8 = sanctionData%>% filter(variableValue == 2| variableValue == 8)%>%ggplot(aes(x= K, y = TotalBM*100))+
viz_sanc_2_8 = sanctionData%>% filter(variableValue == 2| variableValue == 8)%>%ggplot(aes(x= K, y = TotalBM*100))+
  geom_point(aes(color = as.factor(as.numeric(as.character(variableValue))/10)))+
  labs(color = ax_sanc)+
  ylab(axlab_bm)+
  xlab(ax_kf)+
  setGraphs+
  colorDiscrete+
  #ylim(4,21)+
  #xlim(7.5,15)+
  theme(legend.position="bottom")


viz_monSanc_2_8=grid.arrange(arrangeGrob(arrangeGrob(viz_mon_2_8+ggtitle("a)"),viz_sanc_2_8+ggtitle("b)"), ncol=2, nrow=1)))

ggsave("./figs/viz_monSanc.2.8.pdf", viz_monSanc_2_8, width=6, height=3, units="in")

```
surveillance doesn't matter 
```{r}
enfGraph=enfData_vallino%>%mutate(enfValue=rev(as.factor((as.numeric(variableValue)-1)/10)))
viz_surv = enfGraph%>% filter(enfValue == 0.2|enfValue == 0.8)%>%ggplot(aes(x = numLoggers*100, y = TotalBM*100))+
  geom_point(aes(color = enfValue), size = 2)+
  labs(color = ax_mon, x = "Loggers (% remaining)", y = axlab_bm)+
  setGraphs+
  colorDiscrete

ggsave("./figs/viz_vallino_mon.pdf", viz_surv, width=5.75, height=3, units="in")

```
linear regressin models 
```{r}
vallino_lm = lm(TotalBM*100 ~ numLoggers+K+as.numeric(as.character(variableValue)), data = enfData_vallino)
summary(vallino_lm)

vallino_lm2 = lm(TotalBM*100 ~ numLoggers+as.numeric(as.character(variableValue)), data = enfData_vallino%>%filter(variableValue != 100))
summary(vallino_lm2)

monitoring_lm = lm(TotalBM*100 ~ K+as.numeric(as.character(variableValue)), data = monitoringData)
summary(monitoring_lm)

sanction_lm = lm(TotalBM*100 ~ K+as.numeric(as.character(variableValue)), data = sanctionData)
summary(sanction_lm)

mon_sanc_data = allData%>%filter(param == "monitoring" | param == "sanction")%>%mutate(monitoring = ifelse(param == "monitoring", as.numeric(as.character(variableValue)), 50), sanction = ifelse(param == "sanction", as.numeric(as.character(variableValue)), 5)/10 )
mon_sanc_lm = lm(TotalBM*100 ~ K + monitoring + sanction, data = mon_sanc_data)
summary(mon_sanc_lm)
```


Vallino model - monotnic relationship between BM and RT is bc #loggers remaining
```{r}
# see if monotinic relationship between BM and RT is because of # loggers remaining - YES
rtData_vallino%>%ggplot(aes(x = numLoggers, y  = TotalBM*100, color = as.factor(as.numeric(variableValue)/10)))+
  geom_point()+
  labs(color = "reference-threhold")

# example runs of loggers being removed for low and high RT 
vallino_dataRT[[1]][[1]]%>%ggplot(aes(x = 1:200))+
  geom_point(aes(y = numLoggers))+
  geom_point(data = vallino_dataRT[[10]][[1]], aes(y = numLoggers), color = "red")



allData_vallino2 = allData_vallino%>%mutate(initialLoggers = ifelse(param == "log", as.numeric(as.character(variableValue)), 100))

allData_vallino2%>%ggplot(aes(x = numLoggers*initialLoggers, y  = TotalBM*100, color = param))+
  geom_point()+
  labs(color = "parameter varied", x = "Number of Loggers remaining")


allData_vallino2%>%filter(!(param == "log" & as.numeric(as.character(variableValue)) >200) & !(param == "cost" & as.numeric(as.character(variableValue)) >14) ) %>%
  ggplot(aes(x = numLoggers*initialLoggers, y  = TotalBM*100, color = param))+
  geom_point()+
  labs(color = "parameter varied", x = "Number of Loggers remaining")

allData_vallino2%>%filter(param == "log")%>%ggplot(aes(x = numLoggers*initialLoggers, y  = TotalBM*100))+
  geom_point(aes(color = variableValue))+
  labs(color = "initial Loggers", x = "Number of Loggers remaining")


allData_vallino2%>%filter(param == "cost")%>%ggplot(aes(x = numLoggers*initialLoggers, y  = TotalBM*100))+
  geom_point(aes(color = as.factor(as.numeric(as.character(variableValue)))))+
  labs(color = "cost", x = "Number of Loggers remaining")

```

Payoff and BM equilibrium directly related? 

Yes - Payoff and BM directly related
Cost has an influence when Loggers aren't logging at all (payoff dominated by cost)
More GPs correlates with more BM per GP (excluding mtg)
```{r}
allData%>%ggplot(aes(x = TotalBM, y = Payoffs, color =GreenPatches))+
  geom_point()

allData%>%ggplot(aes(x = GreenPatches, y = TotalBM/GreenPatches, color = param))+
  geom_point()
```


My model: looking at why more meetings is better 
```{r}
# calculate jumps
x<-maxK(dataRT, seq(1,10, by=1), 2000, 50)

numberJumps<-findKJumps(dataRT, seq(1,10, by=1), 2000, 50)
whenFinalJump<-findFinalKJumps(dataRT, seq(1,10, by=1), 2000, 50)

numberJumps2<-numberJumps%>%gather(key="variableValue", value=variableOfInterest)%>%separate(col = variableValue, into = c("type", "variableValue"))

jumpDF<-data.frame(maxK=x, jumps=numberJumps2$variableOfInterest, K=rtData$K, TotalBM=rtData$TotalBM, variableValue=rtData$variableValue, cheaters=rtData$numCheaters)

whenFinalJump2<-whenFinalJump%>%gather(key="variableValue", value=variableOfInterest)%>%separate(col = variableValue, into = c("type", "variableValue"))
rtJumpData<-data.frame(maxK=x, numJumps = numberJumps2$variableOfInterest, finalJump=whenFinalJump2$variableOfInterest, K=rtData$K, TotalBM=rtData$TotalBM, variableValue=rtData$variableValue, cheaters=rtData$numCheaters, meanMinCut = rtData$k.i, meanRT = rtData$beta.i, unsatisfied = rtData$unsatisfied)

rtJumpData<- rtJumpData%>%mutate(recentMeeting = finalJump>20)
rtJumpData<- rtJumpData%>%mutate(jumpCat = ifelse(as.numeric(numJumps)<2,"once", ifelse(as.numeric(numJumps)<3, "twice","3+ times")))%>%mutate(jumpCat=factor(jumpCat))



rtJumpData%>%ggplot(aes(variableValue, K-meanMinCut))+
  geom_point(aes(color = jumpCat))

#ggsave("viz_rtJump.pdf", viz_rt_jump, width=5.75, height=3, units="in")
#cor(allData$K, allData$numCheaters)
r = 15
# high rt
x = dataRT[[10]][[r]]
#mid rt
y = dataRT[[4]][[r]]
# low rt 
z = dataRT[[1]][[r]]

tempx = x%>%select(unsatisfied, k.i, K)
tempx$time = 1:200
tempx = tempx%>% gather(key = variable, value = variableValue, -time)

tempx%>%ggplot(aes(group = variable))+
  geom_point(aes(x = time, y = variableValue, color = variable))

tempy = y%>%select(unsatisfied, k.i, K)
tempy$time = 1:200
tempy = tempy%>% gather(key = variable, value = variableValue, -time)

tempy%>%ggplot(aes(group = variable))+
  geom_point(aes(x = time, y = variableValue, color = variable))


tempz = z%>%select(unsatisfied, k.i, K)
tempz$time = 1:200
tempz = tempz%>% gather(key = variable, value = variableValue, -time)

tempz%>%ggplot(aes(group = variable))+
  geom_point(aes(x = time, y = variableValue, color = variable))
  
```



Checking steady state

```{r}
library(urca)

pvals =array(dim = c(50,6))
lag = array(dim = c(50,6))

for (j in 1:6){
for (r in 1:50){
y = dataBase[[j]][[r]]

test = ur.df(y$TotalBM[100:200], type = "drift", lags = 30, selectlags = "AIC")
pvals[r,j] = with(as.list(test@testreg$fstatistic), pf(value, numdf, dendf, lower=FALSE))
lag[r,j] = summary(test)@testreg$fstatistic[2] 
}
}

sum(pvals>=0.1)
summary(test)@testreg

```
```{r}

checkSteadyState = function(dataIn, startTicks, endTicks, runs, numSets, variableOfInterest){
  pvals =array(dim = c(runs,numSets))
  lag = array(dim = c(runs,numSets))  
  
  for (j in 1:numSets){
  for (r in 1:50){
    y = dataIn[[j]][[r]]

    test = ur.df(y[variableOfInterest][startTicks:endTicks,], type = "drift", lags = 30, selectlags = "AIC")
    pvals[r,j] = with(as.list(test@testreg$fstatistic), pf(value, numdf, dendf, lower=FALSE))
    lag[r,j] = summary(test)@testreg$fstatistic[2] 
}
}
  
  return(list(pvals, lag))
}


testSS = checkSteadyState(dataAll, 100, 200, 50, 68, "TotalBM")

sum(testSS[[1]]>=0.1)/(50*68)


testSS_rt = checkSteadyState(dataRT, 100, 200, 50, 10, "TotalBM")
sum(testSS_rt[[1]]>=0.1)

testSS_rt[[1]]>=0.1
```

experimenting 
```{r}
allData%>%ggplot(aes(K, TotalBM*100))+ 
  geom_point(aes(color=numCheaters), alpha = 0.5)+
  #xlim(0,20)+ ylim(0,45)+
  setGraphs +
  #scale_color_manual(breaks=c(TRUE, FALSE), labels = c("60 Loggers", "All other parameter sets"), values=c(color1, color2))+
  theme(legend.title = element_blank())+
  labs(y=axlab_bm, x=ax_kf)

monitoringData%>%ggplot(aes(K, TotalBM*100, color = variableValue))+ 
  geom_point(alpha = 0.5)+
  #xlim(0,20)+ ylim(0,45)+
  setGraphs +
  #scale_color_manual(breaks=c(TRUE, FALSE), labels = c("60 Loggers", "All other parameter sets"), values=c(color1, color2))+
  theme(legend.title = element_blank())+
  labs(y=axlab_bm, x=ax_kf, color = "monitoring-level")


z = lm(TotalBM*100~K+numCheaters, data = allData_plotK_BM)
summary(z)

y = lm(TotalBM*100~K+as.numeric(variableValue), data = monitoringData)
summary(y)

```









## Random jump stuff I may or may not need from FINAL figures file 

Jumps for allData 
```{r}
x<-maxK(dataAll, seq(1,68, by=1), 2000, 50)

#jumps_test<-findKJumps(dataRT, seq(1,10, by=1), 2000, 50)
numberJumps<-findKJumps(dataAll, seq(1,68, by=1), 2000, 50)
whenFinalJump<-findFinalKJumps(dataAll, seq(1,68, by=1), 2000, 50)

numberJumps2_all<-numberJumps%>%gather(key="variableValue", value=variableOfInterest)%>%separate(col = variableValue, into = c("type", "variableValue"))

jumpDF_all<-data.frame(maxK=x, jumps=numberJumps2_all$variableOfInterest, K=allData$K, TotalBM=allData$TotalBM, variableValue=allData$variableValue, cheaters=allData$numCheaters)

whenFinalJump2_all<-whenFinalJump%>%gather(key="variableValue", value=variableOfInterest)%>%separate(col = variableValue, into = c("type", "variableValue"))
allJumpData<-data.frame(maxK=x, numJumps = numberJumps2_all$variableOfInterest, finalJump=whenFinalJump2_all$variableOfInterest, K=allData$K, TotalBM=allData$TotalBM, variableValue=allData$variableValue, cheaters=allData$numCheaters)

allJumpData = allJumpData%>%mutate(recentMeeting = finalJump>100)
allJumpData = allJumpData%>%mutate(jumpCat = ifelse(as.numeric(numJumps)<2,"once", ifelse(as.numeric(numJumps)<3, "twice","3+ times")))%>%mutate(jumpCat=factor(jumpCat))

unique(allJumpData$numJumps)

allJumpData%>%ggplot(aes(x=cheaters, y = round(K,1), color=jumpCat, shape=recentMeeting))+
  geom_count(position="jitter")+
  #geom_smooth(method='glm', se=FALSE, color=color1)+
  labs(x="Number of cheaters", y = ax_kf)+
  setGraphs

head(allJumpData)

```


```{r}
kjumpsAll = findKJumpTimes(dataAll, 1:6, 2000, 50)
bmjumpsAll = findBMJumpTimes(dataAll, 1:6, 2000, 50)

jumpsAll= kjumpsAll%>%gather(key="run", value = "k.jump")
jumps2All= bmjumpsAll%>%gather(key="run", value = "bm.jump")
jumpsAll = jumpsAll%>%mutate(bm.jump=jumps2All$bm.jump, yep=0)

distance = 2
for(i in distance:(dim(jumpsAll)[1])){
  if (jumpsAll$k.jump[i]== 1){
    if(any(jumpsAll$bm.jump[i:(i+distance)]==1)){
      jumpsAll$yep[i] = "BM jumps up"
    }
    else if(all(jumps$bm.jump[(i-distance):i]==-1) & any(jumps$bm.jump[i:(i+distance)]==0)){
      jumpsAll$yep[i] = "BM stops decreasing"
    }
    else{jumpsAll$yep[i] = "BM remains constant"}
  }
}
```

bravo single run
Run this chunk twice for graphs to work (not sure why)
```{r}

endogInst_data = read.csv("./allData_IS/endogInst_data_7_18.csv")
endogInst_data = endogInst_data%>%mutate(Period = 1:2001)
instChange = 15
maxBM = endogInst_data$TotalBM[1]
endogInst_data = endogInst_data%>%mutate(TotalBM = TotalBM/maxBM)
endogInst_run_data = endogInst_data%>%filter(Period <= 200)


#ax_k = expression(paste(bolditalic("current-institution")))
v1b<-endogInst_run_data%>%ggplot(aes(x=Period))+
  geom_path(aes(y=K),  size=line_size)+
  labs(x=element_blank(), y=ax_k)+
  geom_vline(xintercept = instChange, linetype="dashed", color="dimgrey")+
  ylim(0,20)+
  setGraphs

ax = expression(bold(paste("Avg. ", bolditalic("minimal-cut"))))
v2b<-endogInst_run_data%>%ggplot(aes(x=Period))+
  geom_path(aes(y=k.i),  size=line_size)+
  geom_vline(xintercept = instChange, linetype="dashed", color="dimgrey")+
  labs(x=element_blank(), y=ax)+
  ylim(0,20)+
  setGraphs

ax = expression(bold(paste("Avg. ", bolditalic("reference-trees"))))
v3b<-endogInst_run_data%>%ggplot(aes(x=Period))+
  geom_path(aes(y=beta.i),  size=line_size)+
  geom_vline(xintercept = instChange, linetype="dashed", color="dimgrey")+
  labs(x="", y=ax)+
  ylim(0,1)+
  setGraphs

v4b<-endogInst_run_data%>%ggplot(aes(x=Period))+
  geom_path(aes(y=TotalBM*100),  size=line_size)+
  geom_vline(xintercept = instChange, linetype="dashed", color="dimgrey")+
  labs(x="", y=axlab_bm)+
  ylim(0,100)+
  setGraphs


viz_bravo=grid.arrange(v1b+ggtitle("a)"), v2b+ggtitle("b)"), v4b+ggtitle("c)"), v3b+ggtitle("d)"), nrow=2)
viz_bravo=annotate_figure(viz_bravo,
                bottom = text_grob(expression(bold(Period)), vjust = 0,  size = axlab_size),
)

ggsave("./figs/viz_bravo2.pdf", viz_bravo, width=5.75, height=4, units="in")


```

looking at minimal cut polarization - bravo data 
```{r}
mincut_bravo = endogInst_run_data%>%mutate(midMC = 100 - lowMinCut - highMinCut, midMC30 = loggers30Periods - highMC30Periods - lowMC30Periods)
mincut_bravo = mincut_bravo%>%gather(key = "MC.level", value = "NumLogMC", c(highMinCut, lowMinCut, midMC))%>%select(Period, MC.level, NumLogMC)
#mincut_bravo = mincut_bravo%>%arrange(desc(MC.level))
levels(mincut_bravo$MC.level)

mincut_bravo$MC.level <- ordered(mincut_bravo$MC.level, levels = c("midMC", "highMinCut", "lowMinCut"))

viz_minCutBravo = mincut_bravo%>%ggplot(aes(x = Period, y = NumLogMC))+
  geom_area(aes(fill = MC.level), size = line_size, alpha = 0.8)+
  labs(y = "Loggers (% of Total)")+
  setGraphs+
  scale_fill_brewer(palette="Set2",breaks=c("midMC",  "highMinCut", "lowMinCut"),name=ax_mc, labels = c("Medium", "High (> 18)", "Low (< 2)"))

ggsave("./figs/viz_mcPolarization_bravo.pdf", viz_minCutBravo, width=5.75, height=3, units="in")

# showing number of loggers with different minimal cuts
#v5b <- mincut_bravo%>%ggplot(aes(x = Period))+
#mincut_bravo%>%ggplot(aes(x = Period))+
#  geom_path(aes(y = highMinCut),  size=line_size)+
#  geom_path(aes(y = lowMinCut),  size=line_size, color = "green")+
#  geom_path(aes(y = midMC),  size=line_size, color = "blue")+
#  geom_vline(xintercept = instChange, linetype="dashed", color="dimgrey")+
#  labs(x="", y="Loggers (% Total)")+
#  ylim(0,100)+ 
#  xlab("Period")+
#  setGraphs

# showing number of loggers with different minimal cuts (only loggers that have been around at least 30 periods)
#v6b <- endogInst_run_data%>%ggplot(aes(x = Period))+
#  #geom_path(aes(y = loggers30Periods),  size=line_size, color = "grey")+
#  geom_path(aes(y = highMC30Periods/loggers30Periods*100),  size=line_size)+
#  geom_path(aes(y = lowMC30Periods/loggers30Periods*100),  size=line_size, color = "green")+
#  geom_path(aes(y = midMC30),  size=line_size, color = "blue")+
#  geom_vline(xintercept = instChange, linetype="dashed", color="dimgrey")+
#  labs(x="", y="Loggers (% Not Replaced in 30 Periods)")+
#  ylim(0,100)+
#  setGraphs


```

looking at loggers around for at more than 30 periods
```{r}
mincut_bravo30 = endogInst_run_data%>%mutate(midMC = 100 - lowMinCut - highMinCut, midMC30 = loggers30Periods - highMC30Periods - lowMC30Periods)
mincut_bravo30 = mincut_bravo30%>%mutate(midMC30 = midMC30/loggers30Periods*100,highMC30Periods = highMC30Periods/loggers30Periods*100, lowMC30Periods = lowMC30Periods/loggers30Periods *100)
mincut_bravo30 = mincut_bravo30%>%gather(key = "MC.level30", value = "NumLogMC30", c(highMC30Periods, lowMC30Periods, midMC30))%>%select(Period, MC.level30, NumLogMC30)
levels(mincut_bravo30$MC.level30)

mincut_bravo30$MC.level30 <- ordered(mincut_bravo30$MC.level30, levels = c("midMC30", "highMC30Periods", "lowMC30Periods"))

mincut_bravo30%>%ggplot(aes(x = Period, y = NumLogMC30))+
  geom_area(aes(fill = MC.level30), size = line_size, alpha = 0.8)+
  labs(y = "Loggers (% of Total)")+
  setGraphs+
  scale_fill_brewer(palette="Set2",breaks=c("midMC30",  "highMC30Periods", "lowMC30Periods"),name=ax_mc, labels = c("Medium", "High (> 18)", "Low (< 2)"))

mincut_bravo%>%ggplot(aes(x = Period, y = NumLogMC))+
  geom_area(aes(fill = MC.level), size = line_size, alpha = 0.8)+
  labs(y = "Loggers (% of Total)")+
  setGraphs+
  scale_fill_brewer(palette="Set2",breaks=c("midMC",  "highMinCut", "lowMinCut"),name=ax_mc, labels = c("Medium", "High (> 18)", "Low (< 2)"))
```

looking at loggers around for at more than 30 periods AND newer loggers combined
BEST ONE RIGHT NOW! 
```{r}
mincut_bravo30 = endogInst_run_data%>%mutate(midMC = 100 - lowMinCut - highMinCut, midMC30 = loggers30Periods - highMC30Periods - lowMC30Periods, highMC = highMinCut, lowMC = lowMinCut)
mincut_bravo30 = mincut_bravo30%>%mutate(new_midMC = midMC-midMC30, new_highMC = highMinCut - highMC30Periods, new_lowMC = lowMinCut - lowMC30Periods)

mincut_bravo30 = mincut_bravo30%>%gather(key = "MC.level", value = "NumLogMC", c(highMC, lowMC, midMC30, new_midMC))%>%select(Period, MC.level, NumLogMC)
levels(mincut_bravo$MC.level)

mincut_bravo30$MC.level <- ordered(mincut_bravo30$MC.level, levels = c("midMC30","new_midMC","highMC", "lowMC"))

labelHigh = expression(paste("High (", italic("minimal-cut"), " > 18)"))
labelLow = expression(paste("Low (", italic("minimal-cut"), " < 2)"))

# USING THIS IN PAPER FOR THE MOMENT 
viz_minCutBravo = mincut_bravo30%>%ggplot(aes(x = Period, y = NumLogMC))+
  geom_area(aes(fill = MC.level), size = line_size, alpha = 0.8)+
  labs(y = "Loggers (% of Total)")+
  setGraphs+
  scale_fill_manual(breaks=c("new_midMC", "highMC", "lowMC"),name=ax_mc, labels = c("Not polarized", "High (> 18)", "Low (< 2)"), values = c(lighten(color3, amount = 0.3), color3, color1, color2))+
  theme(legend.text.align = 0)

# test = endogInst_run_data%>%mutate(period = 1:200, midMC = 100 - lowMinCut - highMinCut, midMC30 = loggers30Periods - highMC30Periods - lowMC30Periods, highMC = highMinCut, lowMC = lowMinCut)
# test%>%filter(period > 30)%>%summarize(median(midMC30))

  ggsave("./figs/viz_mcPolarization_bravo.pdf", viz_minCutBravo, width=5.75, height=3, units="in")
```

```{r}
mincut_bravo30 = endogInst_run_data%>%mutate(midMC = 100 - lowMinCut - highMinCut, midMC30 = loggers30Periods - highMC30Periods - lowMC30Periods, highMC = highMinCut, lowMC = lowMinCut)
mincut_bravo30 = mincut_bravo30%>%mutate(new_midMC = midMC-midMC30, new_highMC = highMinCut - highMC30Periods, new_lowMC = lowMinCut - lowMC30Periods)

mincut_bravo30 = mincut_bravo30%>%gather(key = "MC.level", value = "NumLogMC", c(highMC30Periods, lowMC30Periods, midMC30, new_midMC, new_highMC, new_lowMC))%>%select(Period, MC.level, NumLogMC)
levels(mincut_bravo$MC.level)
mincut_bravo30$MC.level <- ordered(mincut_bravo30$MC.level, levels = c("midMC30","new_midMC", "highMC30Periods","new_highMC", "lowMC30Periods", "new_lowMC"))

#mincut_bravo30 = mincut_bravo30%>%mutate(new = grepl("new", .$MC.level))

mincut_bravo30%>%ggplot(aes(x = Period, y = NumLogMC))+
  geom_area(aes(fill = MC.level, pattern = new), size = line_size, alpha = 0.8)+
  labs(y = "Loggers (% of Total)")+
  setGraphs+
  scale_fill_manual(breaks=c("midMC30","new_midMC", "highMC30Periods","new_highMC", "lowMC30Periods", "new_lowMC"),name=ax_mc, labels = c("Medium", "Medium (new Loggers)", "High","High (new Loggers)", "Low", "Low (new Loggers)" ), values = c(lighten(color3, amount = 0.3), color3, lighten(color1, amount = 0.3), color1, lighten(color2, amount = 0.3), color2))

```

Checking steady state of TotalBM
```{r}
test_deviation = endogInst_data%>%filter(Period > 200)

test_mean = mean(test_deviation$TotalBM*100)
test_sd = sd(test_deviation$TotalBM*100)
test_mean
test_sd

viz_bmDeviation = test_deviation%>%ggplot(aes(x = TotalBM*100))+
  geom_histogram(fill = color3)+
  geom_vline(xintercept = test_mean, linetype = "dashed")+
  setGraphs+
  labs(y = "# Runs", x = axlab_bm)

ggsave("./figs/viz_bmDeviation_bravo.pdf", viz_bmDeviation, width=4, height=3, units="in")

```



parameters: endogenous institution, base parameters (bmax = 20), 100,000 ticks 
```{r}
bmax = 20
oneThirdBmaxData = read_csv("./allData_IS/one-third-bmax.csv")
oneThirdBmaxData

viz_oneThirdBmax_full = oneThirdBmaxData%>%ggplot(aes(x = period, y = K))+
  geom_line()+
  geom_hline(yintercept = 1/3 * bmax, color = "blue")+
  geom_hline(yintercept = 2/3 * bmax, color = "blue")+
  setGraphs

viz_oneThirdBmax_zoomed = oneThirdBmaxData%>%filter(period >= 6100, period<= 6300)%>%ggplot(aes(x = period, y = K))+
  geom_hline(yintercept = 1/3 * bmax, color = color2, size = 1.5)+
  geom_hline(yintercept = 2/3 * bmax, color = color2, size = 1.5)+
  geom_line()+
  labs(x = "Period", y = ax_kf)+
  setGraphs
viz_oneThirdBmax_zoomed

ggsave("./figs/viz_oneThirdBmax_zoomed.pdf", viz_oneThirdBmax_zoomed, width=4, height=3, units="in")
ggsave("./figs/viz_oneThirdBmax_full.pdf", viz_oneThirdBmax_full, width=4, height=3, units="in")


```


```{r}
inst = vallino_dataLog[[6]][[4]]%>%head(20)
noInst = vallino_dataLog[[6]][[1]]%>%head(20)

inst%>%ggplot(aes(x = 1:20, y = K))+
  geom_path()+
  geom_vline(xintercept = 3, color = "grey")
noInst%>%ggplot(aes(x = 1:20, y = K))+
  geom_path()

inst%>%ggplot(aes(x = 1:20, y = numCheaters))+
  geom_path()+
  geom_vline(xintercept = 3, color = "grey")
noInst%>%ggplot(aes(x = 1:20, y = numCheaters))+
  geom_path()

inst%>%ggplot(aes(x = 1:20, y = numLoggers))+
  geom_path()+
  geom_vline(xintercept = 3, color = "grey")
noInst%>%ggplot(aes(x = 1:20, y = numLoggers))+
  geom_path()

inst%>%ggplot(aes(x = 1:20, y = k.i))+
  geom_path()+
  geom_vline(xintercept = 3, color = "grey")
noInst%>%ggplot(aes(x = 1:20, y = k.i))+
  geom_path()
```

